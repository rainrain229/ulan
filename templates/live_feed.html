{% extends "base.html" %}

{% block title %}Live Feed - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-video me-2"></i>Live Camera Feed
                </h4>
            </div>
            <div class="card-body">
                <div class="video-container text-center">
                    <img src="{{ url_for('video_feed') }}" 
                         alt="Live Camera Feed" 
                         class="img-fluid"
                         style="max-width: 100%; height: auto; border-radius: 10px;">
                </div>
                
                <div class="mt-3 text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instructions:</strong> Position students in front of the camera. 
                        The system will automatically detect and mark attendance when a registered face is recognized.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Live Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <h6>Recognition Status</h6>
                    <div class="badge bg-success fs-6 p-2">
                        <i class="fas fa-eye me-1"></i>Active
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Today's Attendance</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="attendance-progress">
                            <span id="attendance-count">0</span>
                        </div>
                    </div>
                    <small class="text-muted">Students marked present today</small>
                </div>
                
                <div class="mb-3">
                    <h6>Current Time</h6>
                    <h4 class="text-primary" id="current-time">--:--:--</h4>
                </div>
                
                <div class="mb-3">
                    <h6>Camera Status</h6>
                    <div class="badge bg-success">
                        <i class="fas fa-circle me-1"></i>Connected
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Recent Activity</h6>
                    <div id="activity-log" style="max-height: 200px; overflow-y: auto;">
                        <small class="text-muted">Waiting for activity...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('attendance') }}" class="btn btn-info">
                        <i class="fas fa-list me-2"></i>View Today's Attendance
                    </a>
                    <a href="{{ url_for('export_attendance') }}" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Export Report
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Real-time clock
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('current-time').textContent = timeString;
    }
    
    // Update time every second
    setInterval(updateTime, 1000);
    updateTime(); // Initial call
    
    // Simulate activity updates (in a real system, this would come from websockets or periodic AJAX calls)
    let activityCount = 0;
    function addActivity(message) {
        const activityLog = document.getElementById('activity-log');
        const now = new Date().toLocaleTimeString();
        const activityItem = document.createElement('div');
        activityItem.className = 'small mb-1';
        activityItem.innerHTML = `<span class="text-muted">${now}</span> - ${message}`;
        
        if (activityLog.children.length === 1 && activityLog.children[0].textContent === 'Waiting for activity...') {
            activityLog.innerHTML = '';
        }
        
        activityLog.insertBefore(activityItem, activityLog.firstChild);
        
        // Keep only last 10 activities
        while (activityLog.children.length > 10) {
            activityLog.removeChild(activityLog.lastChild);
        }
        
        activityCount++;
        document.getElementById('attendance-count').textContent = activityCount;
        
        const progressBar = document.getElementById('attendance-progress');
        const percentage = Math.min((activityCount / 30) * 100, 100); // Assuming 30 is full class
        progressBar.style.width = percentage + '%';
    }
    
    // Auto-refresh to check for new attendance (in production, use websockets)
    let lastActivityTime = Date.now();
    setInterval(function() {
        // This is just a demo - in production, you'd poll the server or use websockets
        if (Math.random() < 0.1) { // 10% chance every 5 seconds
            const studentNames = ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Wilson'];
            const randomStudent = studentNames[Math.floor(Math.random() * studentNames.length)];
            addActivity(`Attendance marked for ${randomStudent}`);
        }
    }, 5000);
</script>
{% endblock %}

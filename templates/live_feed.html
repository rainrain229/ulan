{% extends "base.html" %}

{% block title %}Live Feed - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-video me-2"></i>Live Camera Feed
                </h4>
                <div>
                    <div class="btn-group" role="group" aria-label="Mode">
                        <a href="{{ url_for('live_feed') }}" class="btn btn-outline-primary{% if request.args.get('mode', 'student') != 'teacher' %} active{% endif %}">
                            <i class="fas fa-user"></i> Students
                        </a>
                        <a href="{{ url_for('live_feed') }}?mode=teacher" class="btn btn-outline-primary{% if request.args.get('mode', 'student') == 'teacher' %} active{% endif %}">
                            <i class="fas fa-chalkboard-teacher"></i> Teachers
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="video-container text-center">
                    <img src="{{ url_for('video_feed') }}?mode={{ request.args.get('mode', 'student') }}" 
                         alt="Live Camera Feed" 
                         class="img-fluid"
                         style="max-width: 100%; height: auto; border-radius: 10px;">
                </div>
                
                <div class="mt-3 text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if request.args.get('mode', 'student') == 'teacher' %}
                            <strong>Teachers:</strong> Look at the camera to verify liveness, then press IN/OUT below. The most recently recognized teacher will be auto-selected for 10 seconds.
                        {% else %}
                            <strong>Instructions:</strong> Position students in front of the camera. Attendance will be marked automatically when a registered face is recognized.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Live Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <h6>Recognition Status</h6>
                    <div class="badge bg-success fs-6 p-2">
                        <i class="fas fa-eye me-1"></i>Active
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Today's Attendance</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="attendance-progress">
                            <span id="attendance-count">0</span>
                        </div>
                    </div>
                    <small class="text-muted">Students marked present today</small>
                </div>
                
                <div class="mb-3">
                    <h6>Current Time</h6>
                    <h4 class="text-primary" id="current-time">--:--:--</h4>
                </div>
                
                <div class="mb-3">
                    <h6>Camera Status</h6>
                    <div class="badge bg-success">
                        <i class="fas fa-circle me-1"></i>Connected
                    </div>
                </div>
                
                <div class="mb-3" id="teacherPanel" style="display: {% if request.args.get('mode', 'student') == 'teacher' %}block{% else %}none{% endif %};">
                    <h6>Teacher Controls</h6>
                    <div class="d-grid gap-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                            <input id="teacherIdInput" type="text" class="form-control" placeholder="Teacher ID (auto-filled)" />
                        </div>
                        <button id="inBtn" class="btn btn-success">
                            <i class="fas fa-sign-in-alt me-2"></i>IN
                        </button>
                        <button id="outBtn" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>OUT
                        </button>
                        <div class="small text-muted" id="lastTeacherInfo">Waiting for recognition...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('attendance') }}" class="btn btn-info">
                        <i class="fas fa-list me-2"></i>View Today's Student Attendance
                    </a>
                    <a href="{{ url_for('teacher_attendance') }}" class="btn btn-info">
                        <i class="fas fa-list me-2"></i>View Today's Teacher Attendance
                    </a>
                    <a href="{{ url_for('export_attendance') }}" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Export Student Report
                    </a>
                    <a href="{{ url_for('export_teacher_attendance') }}" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Export Teacher Report
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('current-time').textContent = timeString;
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Demo attendance progress
    let activityCount = 0;
    function setCount(n){
        activityCount = n;
        document.getElementById('attendance-count').textContent = activityCount;
        const progressBar = document.getElementById('attendance-progress');
        const percentage = Math.min((activityCount / 30) * 100, 100);
        progressBar.style.width = percentage + '%';
    }

    // Teacher polling for last recognized
    async function pollLastTeacher(){
        try{
            const res = await fetch('/api/last_recognized_teacher');
            const data = await res.json();
            const info = document.getElementById('lastTeacherInfo');
            if(data.ok){
                document.getElementById('teacherIdInput').value = data.teacher_id;
                info.textContent = `Recognized: ${data.name} (${data.teacher_id})`;
            }else{
                info.textContent = 'Waiting for recognition...';
            }
        }catch(e){
            // ignore
        }
    }

    const teacherMode = new URLSearchParams(window.location.search).get('mode') === 'teacher';
    if(teacherMode){
        setInterval(pollLastTeacher, 2000);
        pollLastTeacher();
        document.getElementById('inBtn').addEventListener('click', async () => {
            const fd = new FormData();
            const id = document.getElementById('teacherIdInput').value;
            if(id){ fd.append('teacher_id', id); }
            const res = await fetch('/api/teacher_in', { method: 'POST', body: fd });
            const data = await res.json();
            alert(data.ok ? 'IN logged' : 'Failed: ' + (data.error || 'unknown'));
        });
        document.getElementById('outBtn').addEventListener('click', async () => {
            const fd = new FormData();
            const id = document.getElementById('teacherIdInput').value;
            if(id){ fd.append('teacher_id', id); }
            const res = await fetch('/api/teacher_out', { method: 'POST', body: fd });
            const data = await res.json();
            alert(data.ok ? 'OUT logged' : 'Failed: ' + (data.error || 'unknown'));
        });
    }
</script>
{% endblock %}

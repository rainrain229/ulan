{% extends "base.html" %}

{% block title %}Analytics - Smart Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Analytics Dashboard
        </h1>
        <p class="text-muted">Comprehensive attendance analysis and insights</p>
    </div>
</div>

<!-- Analytics Overview Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <div class="stats-number text-primary" id="avgStudentAttendance">0%</div>
                <div class="stats-label">Avg Student Attendance</div>
                <div class="mt-2">
                    <i class="fas fa-chart-line fa-2x text-primary"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <div class="stats-number text-success" id="avgTeacherAttendance">0%</div>
                <div class="stats-label">Avg Teacher Attendance</div>
                <div class="mt-2">
                    <i class="fas fa-chalkboard-teacher fa-2x text-success"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <div class="stats-number text-info" id="totalClasses">0</div>
                <div class="stats-label">Total Classes</div>
                <div class="mt-2">
                    <i class="fas fa-graduation-cap fa-2x text-info"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <div class="stats-number text-warning" id="totalDepartments">0</div>
                <div class="stats-label">Total Departments</div>
                <div class="mt-2">
                    <i class="fas fa-building fa-2x text-warning"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily Attendance Trends -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    30-Day Attendance Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="dailyTrendsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Class-wise and Department-wise Analysis -->
<div class="row mb-4">
    <!-- Class-wise Attendance -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Class-wise Attendance
                </h5>
            </div>
            <div class="card-body">
                {% if class_stats %}
                    <canvas id="classChart" height="200"></canvas>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>No class data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Department-wise Teacher Attendance -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>
                    Department-wise Teacher Attendance
                </h5>
            </div>
            <div class="card-body">
                {% if dept_stats %}
                    <canvas id="departmentChart" height="200"></canvas>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>No department data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Statistics Tables -->
<div class="row">
    <!-- Class Statistics -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Class Statistics
                </h5>
            </div>
            <div class="card-body">
                {% if class_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Total</th>
                                    <th>Present</th>
                                    <th>Attendance %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in class_stats %}
                                <tr>
                                    <td><strong>{{ stat.class_name }}</strong></td>
                                    <td>{{ stat.total }}</td>
                                    <td>{{ stat.present }}</td>
                                    <td>
                                        {% set percentage = (stat.present / stat.total * 100) if stat.total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar 
                                                {% if percentage >= 80 %}bg-success
                                                {% elif percentage >= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                 style="width: {{ percentage }}%">
                                                {{ "%.1f"|format(percentage) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <p>No class statistics available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Department Statistics -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Department Statistics
                </h5>
            </div>
            <div class="card-body">
                {% if dept_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Total</th>
                                    <th>Present</th>
                                    <th>Attendance %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in dept_stats %}
                                <tr>
                                    <td><strong>{{ stat.department or 'Unassigned' }}</strong></td>
                                    <td>{{ stat.total }}</td>
                                    <td>{{ stat.present }}</td>
                                    <td>
                                        {% set percentage = (stat.present / stat.total * 100) if stat.total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar 
                                                {% if percentage >= 80 %}bg-success
                                                {% elif percentage >= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                 style="width: {{ percentage }}%">
                                                {{ "%.1f"|format(percentage) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <p>No department statistics available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Analytics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('export_attendance') }}?date={{ today }}" class="btn btn-success w-100">
                            <i class="fas fa-file-csv me-2"></i>
                            Student Attendance
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('export_teacher_attendance') }}?date={{ today }}" class="btn btn-info w-100">
                            <i class="fas fa-file-csv me-2"></i>
                            Teacher Attendance
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-warning w-100" onclick="exportChartAsImage()">
                            <i class="fas fa-image me-2"></i>
                            Export Charts
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-file-pdf me-2"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Daily Trends Chart
const dailyCtx = document.getElementById('dailyTrendsChart').getContext('2d');
const dailyTrendsChart = new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: {{ daily_stats | map(attribute='date') | list | tojson }},
        datasets: [{
            label: 'Students',
            data: {{ daily_stats | map(attribute='students') | list | tojson }},
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Teachers',
            data: {{ daily_stats | map(attribute='teachers') | list | tojson }},
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            },
            title: {
                display: true,
                text: 'Daily Attendance Trends (Last 30 Days)'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of People'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        }
    }
});

// Class Chart
{% if class_stats %}
const classCtx = document.getElementById('classChart').getContext('2d');
const classChart = new Chart(classCtx, {
    type: 'doughnut',
    data: {
        labels: {{ class_stats | map(attribute='class_name') | list | tojson }},
        datasets: [{
            data: {{ class_stats | map(attribute='total') | list | tojson }},
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            title: {
                display: true,
                text: 'Students per Class'
            }
        }
    }
});
{% endif %}

// Department Chart
{% if dept_stats %}
const deptCtx = document.getElementById('departmentChart').getContext('2d');
const departmentChart = new Chart(deptCtx, {
    type: 'bar',
    data: {
        labels: {{ dept_stats | map(attribute='department') | list | tojson }},
        datasets: [{
            label: 'Total Teachers',
            data: {{ dept_stats | map(attribute='total') | list | tojson }},
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: '#667eea',
            borderWidth: 1
        }, {
            label: 'Present Today',
            data: {{ dept_stats | map(attribute='present') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: '#28a745',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            },
            title: {
                display: true,
                text: 'Teachers per Department'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Teachers'
                }
            }
        }
    }
});
{% endif %}

// Calculate and display summary statistics
function calculateSummaryStats() {
    // Calculate average student attendance
    const classData = {{ class_stats | tojson }};
    let totalStudents = 0;
    let totalPresent = 0;
    
    classData.forEach(stat => {
        totalStudents += stat.total;
        totalPresent += stat.present;
    });
    
    const avgStudentAttendance = totalStudents > 0 ? Math.round((totalPresent / totalStudents) * 100) : 0;
    document.getElementById('avgStudentAttendance').textContent = avgStudentAttendance + '%';
    
    // Calculate average teacher attendance
    const deptData = {{ dept_stats | tojson }};
    let totalTeachers = 0;
    let totalPresentTeachers = 0;
    
    deptData.forEach(stat => {
        totalTeachers += stat.total;
        totalPresentTeachers += stat.present;
    });
    
    const avgTeacherAttendance = totalTeachers > 0 ? Math.round((totalPresentTeachers / totalTeachers) * 100) : 0;
    document.getElementById('avgTeacherAttendance').textContent = avgTeacherAttendance + '%';
    
    // Display other stats
    document.getElementById('totalClasses').textContent = classData.length;
    document.getElementById('totalDepartments').textContent = deptData.length;
}

// Export chart as image
function exportChartAsImage() {
    const link = document.createElement('a');
    link.download = 'attendance_charts.png';
    
    // Create a canvas with all charts
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1200;
    canvas.height = 800;
    
    // This is a simplified export - in a real implementation, you'd use html2canvas or similar
    alert('Chart export functionality would be implemented here. Consider using html2canvas library for full chart export capabilities.');
}

// Generate comprehensive report
function generateReport() {
    alert('Report generation functionality would be implemented here. This could include:\n\n' +
          '• PDF generation with all charts and statistics\n' +
          '• Executive summary\n' +
          '• Recommendations based on attendance patterns\n' +
          '• Historical comparison data');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateSummaryStats();
    
    // Auto-refresh analytics every 10 minutes
    setInterval(function() {
        window.location.reload();
    }, 600000);
});

// Add responsive behavior for charts
window.addEventListener('resize', function() {
    if (dailyTrendsChart) dailyTrendsChart.resize();
    {% if class_stats %}if (classChart) classChart.resize();{% endif %}
    {% if dept_stats %}if (departmentChart) departmentChart.resize();{% endif %}
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Change Password - Smart Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-0">
            <i class="fas fa-key me-2"></i>
            Change Password
        </h1>
        <p class="text-muted">Update your account password for enhanced security</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Password Update
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">
                            <i class="fas fa-lock me-1"></i>
                            Current Password *
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="current_password" 
                                   name="current_password" required>
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="togglePassword('current_password')">
                                <i class="fas fa-eye" id="current_eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Enter your current password to verify your identity</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="fas fa-key me-1"></i>
                            New Password *
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="new_password" 
                                   name="new_password" required minlength="8">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="togglePassword('new_password')">
                                <i class="fas fa-eye" id="new_eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-check-circle me-1"></i>
                            Confirm New Password *
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" 
                                   name="confirm_password" required minlength="8">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="togglePassword('confirm_password')">
                                <i class="fas fa-eye" id="confirm_eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Re-enter your new password to confirm</div>
                    </div>
                    
                    <!-- Password Strength Indicator -->
                    <div class="mb-3">
                        <label class="form-label">Password Strength</label>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" 
                                 style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="strengthText">Enter a password to check strength</small>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Password Requirements</h6>
                        <ul class="mb-0 small">
                            <li id="req_length">At least 8 characters long</li>
                            <li id="req_uppercase">Contains uppercase letter (A-Z)</li>
                            <li id="req_lowercase">Contains lowercase letter (a-z)</li>
                            <li id="req_number">Contains number (0-9)</li>
                            <li id="req_special">Contains special character (!@#$%^&*)</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-save me-2"></i>
                            Update Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Security Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Security Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li>Use a unique password that you don't use elsewhere</li>
                    <li>Consider using a passphrase instead of a single word</li>
                    <li>Enable two-factor authentication if available</li>
                    <li>Never share your password with anyone</li>
                    <li>Change your password regularly</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password visibility toggle
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const eye = document.getElementById(inputId.replace('_password', '_eye'));
    
    if (input.type === 'password') {
        input.type = 'text';
        eye.classList.remove('fa-eye');
        eye.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        eye.classList.remove('fa-eye-slash');
        eye.classList.add('fa-eye');
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    let requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*]/.test(password)
    };
    
    // Calculate strength score
    Object.values(requirements).forEach(met => {
        if (met) strength += 20;
    });
    
    // Update progress bar
    const progressBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');
    
    progressBar.style.width = strength + '%';
    
    if (strength < 40) {
        progressBar.className = 'progress-bar bg-danger';
        strengthText.textContent = 'Weak password';
        strengthText.className = 'text-danger';
    } else if (strength < 80) {
        progressBar.className = 'progress-bar bg-warning';
        strengthText.textContent = 'Moderate password';
        strengthText.className = 'text-warning';
    } else {
        progressBar.className = 'progress-bar bg-success';
        strengthText.textContent = 'Strong password';
        strengthText.className = 'text-success';
    }
    
    // Update requirement indicators
    document.getElementById('req_length').className = requirements.length ? 'text-success' : 'text-danger';
    document.getElementById('req_uppercase').className = requirements.uppercase ? 'text-success' : 'text-danger';
    document.getElementById('req_lowercase').className = requirements.lowercase ? 'text-success' : 'text-danger';
    document.getElementById('req_number').className = requirements.number ? 'text-success' : 'text-danger';
    document.getElementById('req_special').className = requirements.special ? 'text-success' : 'text-danger';
    
    return strength;
}

// Form validation
function validateForm() {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Check if all fields are filled
    const allFilled = currentPassword && newPassword && confirmPassword;
    
    // Check if passwords match
    const passwordsMatch = newPassword === confirmPassword;
    
    // Check if new password is strong enough
    const passwordStrength = checkPasswordStrength(newPassword);
    const isStrongEnough = passwordStrength >= 60; // At least 3 requirements met
    
    // Enable/disable submit button
    submitBtn.disabled = !(allFilled && passwordsMatch && isStrongEnough);
    
    // Show validation messages
    if (newPassword && confirmPassword && !passwordsMatch) {
        document.getElementById('confirm_password').classList.add('is-invalid');
        if (!document.querySelector('.invalid-feedback')) {
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = 'Passwords do not match';
            document.getElementById('confirm_password').parentNode.appendChild(feedback);
        }
    } else {
        document.getElementById('confirm_password').classList.remove('is-invalid');
        const feedback = document.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['current_password', 'new_password', 'confirm_password'];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        input.addEventListener('input', validateForm);
        input.addEventListener('blur', validateForm);
    });
    
    // Form submission
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('New passwords do not match!');
            return;
        }
        
        if (checkPasswordStrength(newPassword) < 60) {
            e.preventDefault();
            alert('Please choose a stronger password that meets the requirements.');
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        submitBtn.disabled = true;
    });
});

// Real-time password strength checking
document.getElementById('new_password').addEventListener('input', function() {
    checkPasswordStrength(this.value);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Change Password - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key text-primary"></i> Change Password
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">
                            <i class="fas fa-lock"></i> Current Password *
                        </label>
                        <input type="password" class="form-control" id="current_password" 
                               name="current_password" required>
                        <div class="form-text">Enter your current password to verify your identity</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="fas fa-key"></i> New Password *
                        </label>
                        <input type="password" class="form-control" id="new_password" 
                               name="new_password" required minlength="8">
                        <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-check-circle"></i> Confirm New Password *
                        </label>
                        <input type="password" class="form-control" id="confirm_password" 
                               name="confirm_password" required minlength="8">
                        <div class="form-text">Re-enter your new password to confirm</div>
                    </div>
                    
                    <!-- Password Strength Indicator -->
                    <div class="mb-3">
                        <label class="form-label">Password Strength</label>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" 
                                 style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="strengthText">Enter a password to check strength</small>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Password Requirements:</h6>
                        <ul class="mb-0 small">
                            <li id="req-length">At least 8 characters long</li>
                            <li id="req-uppercase">Contains uppercase letter</li>
                            <li id="req-lowercase">Contains lowercase letter</li>
                            <li id="req-number">Contains number</li>
                            <li id="req-special">Contains special character</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Security Tips -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Security Tips</h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Use a unique password that you don't use elsewhere</li>
                    <li>Consider using a passphrase instead of a single word</li>
                    <li>Enable two-factor authentication if available</li>
                    <li>Never share your password with anyone</li>
                    <li>Change your password regularly</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentPassword = document.getElementById('current_password');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submitBtn');
    const passwordStrength = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        // Length check
        if (password.length >= 8) {
            score += 20;
            document.getElementById('req-length').style.color = 'green';
        } else {
            document.getElementById('req-length').style.color = 'red';
        }
        
        // Uppercase check
        if (/[A-Z]/.test(password)) {
            score += 20;
            document.getElementById('req-uppercase').style.color = 'green';
        } else {
            document.getElementById('req-uppercase').style.color = 'red';
        }
        
        // Lowercase check
        if (/[a-z]/.test(password)) {
            score += 20;
            document.getElementById('req-lowercase').style.color = 'green';
        } else {
            document.getElementById('req-lowercase').style.color = 'red';
        }
        
        // Number check
        if (/\d/.test(password)) {
            score += 20;
            document.getElementById('req-number').style.color = 'green';
        } else {
            document.getElementById('req-number').style.color = 'red';
        }
        
        // Special character check
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            score += 20;
            document.getElementById('req-special').style.color = 'green';
        } else {
            document.getElementById('req-special').style.color = 'red';
        }
        
        // Update strength bar
        passwordStrength.style.width = score + '%';
        
        if (score < 40) {
            passwordStrength.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak password';
        } else if (score < 80) {
            passwordStrength.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Moderate password';
        } else {
            passwordStrength.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong password';
        }
        
        return score;
    }
    
    // Check if passwords match
    function checkPasswordsMatch() {
        if (newPassword.value === confirmPassword.value && newPassword.value.length > 0) {
            confirmPassword.style.borderColor = '#28a745';
            confirmPassword.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
        } else if (confirmPassword.value.length > 0) {
            confirmPassword.style.borderColor = '#dc3545';
            confirmPassword.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        } else {
            confirmPassword.style.borderColor = '#e9ecef';
            confirmPassword.style.boxShadow = 'none';
        }
    }
    
    // Enable/disable submit button
    function updateSubmitButton() {
        const currentPasswordValid = currentPassword.value.length > 0;
        const newPasswordValid = newPassword.value.length >= 8;
        const passwordsMatch = newPassword.value === confirmPassword.value;
        const passwordStrong = checkPasswordStrength(newPassword.value) >= 60;
        
        submitBtn.disabled = !(currentPasswordValid && newPasswordValid && passwordsMatch && passwordStrong);
    }
    
    // Event listeners
    currentPassword.addEventListener('input', updateSubmitButton);
    newPassword.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordsMatch();
        updateSubmitButton();
    });
    confirmPassword.addEventListener('input', function() {
        checkPasswordsMatch();
        updateSubmitButton();
    });
    
    // Form validation
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        if (newPassword.value !== confirmPassword.value) {
            e.preventDefault();
            alert('New passwords do not match!');
            return;
        }
        
        if (newPassword.value.length < 8) {
            e.preventDefault();
            alert('New password must be at least 8 characters long!');
            return;
        }
        
        if (checkPasswordStrength(newPassword.value) < 60) {
            e.preventDefault();
            alert('Please choose a stronger password!');
            return;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
        submitBtn.disabled = true;
    });
    
    // Initialize password requirements colors
    document.querySelectorAll('[id^="req-"]').forEach(el => {
        el.style.color = 'red';
    });
});
</script>
{% endblock %}